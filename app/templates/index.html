<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto-Flow: Unified Analysis Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/de.min.js "></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css " rel="stylesheet"/>
    <link rel="stylesheet" href="/static/style.css">

    <!-- TransactionVisualizer Code -->
    <script>
        const TransactionVisualizer = (function() {
            // Private Variablen und Hilfsfunktionen
            const currencyColors = {
                btc: '#f2a900',
                eth: '#627eea',
                sol: '#00ffbd'
            };

            function showLoading(container) {
                container.innerHTML = '';
                container.className = 'loading';
            }

            function showError(container, message) {
                container.classList.remove('loading');
                container.innerHTML = `<div class="error-message">${message}</div>`;
            }

            function updateInfoPanels(data) {
                // Start-Informationen
                document.getElementById('sourceCurrency').textContent = data.source_currency || '-';
                document.getElementById('sourceCurrency').className = 'transaction-value value-' + (data.source_currency || '').toLowerCase();
                document.getElementById('startHash').textContent = data.start_transaction || '-';
                
                const startTime = data.transactions && data.transactions[0] ? 
                    new Date(data.transactions[0].timestamp * 1000).toLocaleString() : '-';
                document.getElementById('startTime').textContent = startTime;
                
                // Transaktionsstatistik aktualisieren
                document.getElementById('txCount').textContent = data.transactions_count || 0;
                
                let totalValue = 0;
                let totalFees = 0;
                
                if (data.transactions && data.transactions.length > 0) {
                    if (data.transactions[0].currency === 'BTC') {
                        totalValue = data.transactions[0].inputs.reduce((sum, input) => sum + input.value, 0);
                    }
                    totalFees = data.transactions.reduce((sum, tx) => sum + (tx.fee || 0), 0);
                }
                
                document.getElementById('totalValue').textContent = 
                    `${totalValue.toFixed(8)} ${data.source_currency}`;
                document.getElementById('totalValue').className = 
                    `transaction-value value-${(data.source_currency || '').toLowerCase()}`;
                    
                document.getElementById('totalFees').textContent = 
                    `${totalFees.toFixed(8)} ${data.source_currency}`;
                document.getElementById('totalFees').className = 
                    `transaction-value value-${(data.source_currency || '').toLowerCase()}`;
                
                // Konvertierungsinformationen
                document.getElementById('targetCurrencyDisplay').textContent = data.target_currency || '-';
                document.getElementById('targetCurrencyDisplay').className = 
                    `transaction-value value-${(data.target_currency || '').toLowerCase()}`;
                
                let exchangeRate = 1.0;
                if (data.transactions && data.transactions[0] && data.transactions[0].inputs && data.transactions[0].inputs[0]) {
                    const input = data.transactions[0].inputs[0];
                    if (input.value > 0 && input.value_converted) {
                        exchangeRate = input.value_converted / input.value;
                    }
                }
                
                document.getElementById('exchangeRate').textContent = 
                    `1 ${data.source_currency} = ${exchangeRate.toFixed(4)} ${data.target_currency}`;
                    
                const convertedValue = totalValue * exchangeRate;
                document.getElementById('convertedValue').textContent = 
                    `${convertedValue.toFixed(4)} ${data.target_currency}`;
                document.getElementById('convertedValue').className = 
                    `transaction-value value-${(data.target_currency || '').toLowerCase()}`;
            }

            function createTransactionTree(data, container) {
                if (!data.transactions || data.transactions.length === 0) {
                    return;
                }
                
                const mainTx = data.transactions[0];
                let svgContent = '';
                
                if (mainTx.currency === 'BTC') {
                    svgContent = createSVGTreeFromBTCTransaction(mainTx, data.target_currency);
                } else if (mainTx.currency === 'ETH') {
                    svgContent = createSVGTreeFromETHTransaction(mainTx, data.target_currency);
                } else if (mainTx.currency === 'SOL') {
                    svgContent = createSVGTreeFromSOLTransaction(mainTx, data.target_currency);
                } else {
                    svgContent = createSVGTreeFromBTCTransaction(mainTx, data.target_currency);
                }
                
                container.innerHTML = svgContent;
            }

            // Öffentliche API
            return {
                showLoading: function(containerId) {
                    const container = document.getElementById(containerId);
                    showLoading(container);
                },
                
                showError: function(containerId, message) {
                    const container = document.getElementById(containerId);
                    showError(container, message);
                },
                
                visualizeTransactions: function(data, containerId) {
                    const container = document.getElementById(containerId);
                    
                    if (!data || !data.transactions || data.transactions.length === 0) {
                        showError(container, 'Keine Transaktionsdaten verfügbar.');
                        return;
                    }
                    
                    updateInfoPanels(data);
                    
                    container.classList.remove('loading');
                    createTransactionTree(data, container);
                },
                
                setCurrencyColors: function(colors) {
                    if (colors.btc) currencyColors.btc = colors.btc;
                    if (colors.eth) currencyColors.eth = colors.eth;
                    if (colors.sol) currencyColors.sol = colors.sol;
                }
            };
        })();

        window.TransactionVisualizer = TransactionVisualizer;
    </script>

    <!-- Main Application Code -->
    <script>
        const API_BASE_URL = '/api/v1';

        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initTransactionTracker();
            initSocialAnalysis();
            initializeDates();
        });

        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        function initializeDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start_date').value = today;
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('end_date').value = tomorrow.toISOString().split('T')[0];
        }

        function initTransactionTracker() {
            document.getElementById('trackButton').addEventListener('click', trackTransactions);
        }

        async function trackTransactions() {
            const startTx = document.getElementById('startTx').value;
            const targetCurrency = document.getElementById('targetCurrency').value;
            const numTransactions = parseInt(document.getElementById('numTransactions').value, 10);
            
            if (!startTx) {
                showError('Bitte geben Sie eine Starttransaktion ein.');
                return;
            }
            
            showLoading();
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                const data = generateSampleData(startTx, targetCurrency, numTransactions);
                visualizeTransactions(data);
            } catch (error) {
                console.error('Fehler beim Abrufen der Transaktionsdaten:', error);
                showError('Transaktionsdaten konnten nicht abgerufen werden.');
            }
        }

        function visualizeTransactions(data) {
            TransactionVisualizer.visualizeTransactions(data, 'transactionTree');
        }

        function showLoading() {
            TransactionVisualizer.showLoading('transactionTree');
        }

        function showError(message) {
            TransactionVisualizer.showError('transactionTree', message);
        }

        function initSocialAnalysis() {
            document.getElementById('analysisForm').addEventListener('submit', submitAnalysis);
        }

        async function submitAnalysis(event) {
            event.preventDefault();
            
            try {
                const formData = {
                    blockchain: document.getElementById('blockchain').value,
                    contract_address: document.getElementById('contract_address').value.trim() || null,
                    twitter_username: document.getElementById('twitter_username').value.trim(),
                    keywords: document.getElementById('keywords').value.split(',').map(k => k.trim()).filter(Boolean),
                    start_date: document.getElementById('start_date').value,
                    end_date: document.getElementById('end_date').value,
                    tweet_limit: parseInt(document.getElementById('tweet_limit').value, 10)
                };
            
                const response = await fetch(`${API_BASE_URL}/analyze/rule-based`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
            
                // Update the status polling function:
                async function getAnalysisStatus(jobId) {
                    try {
                        // Fix: Use API_BASE_URL
                        const response = await fetch(`${API_BASE_URL}/analysis/status/${jobId}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return await response.json();
                    } catch (error) {
                        console.error('Fehler beim Abrufen des Status:', error);
                        throw error;
                    }
                }

        
        async function simulatePolling(jobId) {
            const resultDiv = document.getElementById('result');
            
            const interval = setInterval(async () => {
                try {
                    const status = await getAnalysisStatus(jobId);
                    
                    if (status.status === "Completed") {
                        clearInterval(interval);
                        
                        resultDiv.innerHTML = `
                            <h3>Analyse abgeschlossen!</h3>
                            <p><strong>Job-ID:</strong> ${jobId}</p>
                            <p><strong>Status:</strong> ${status.status}</p>
                            <div class="analysis-results">
                                <h4>Gefundene Wallet-Adressen:</h4>
                                ${status.potential_wallets && status.potential_wallets.length > 0 
                                    ? `<ul>${status.potential_wallets.map(wallet => `<li>${wallet}</li>`).join('')}</ul>`
                                    : '<p>Keine Wallet-Adressen gefunden.</p>'
                                }
                                <p><strong>Analysierte Tweets:</strong> ${status.analyzed_tweets}</p>
                                <p><strong>Analysierte Transaktionen:</strong> ${status.analyzed_transactions}</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>Analyse läuft...</h3>
                            <p><strong>Job-ID:</strong> ${jobId}</p>
                            <p><strong>Status:</strong> ${status.status}</p>
                        `;
                    }
                } catch (error) {
                    clearInterval(interval);
                    resultDiv.innerHTML = `
                        <h3>Fehler!</h3>
                        <p>Fehler beim Abrufen des Analyse-Status: ${error.message}</p>
                    `;
                }
            }, 2000);
        }

        async function getAnalysisStatus(jobId) {
            try {
                const response = await fetch(`${API_BASE_URL}/analysis/status/${jobId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Fehler beim Abrufen des Status:', error);
                throw error;
            }
        }

        function generateSampleData(startTx, targetCurrency, numTransactions) {
            // This is a placeholder function to generate sample data
            // In a real implementation, this would be replaced by actual API calls
            return {
                source_currency: "BTC",
                target_currency: targetCurrency,
                start_transaction: startTx,
                transactions_count: numTransactions,
                transactions: [{
                    currency: "BTC",
                    timestamp: Date.now() / 1000,
                    inputs: [{ value: 1.0, value_converted: 1.5 }],
                    fee: 0.0001
                }]
            };
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Crypto-Flow: Unified Analysis Dashboard</h1>
            <button class="refresh-btn" id="refreshBtn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div class="tabs">
            <div class="tab active" data-tab="transaction-tracker">Transaction Tracker</div>
            <div class="tab" data-tab="social-analysis">Social Analysis</div>
        </div>
        
        <!-- Transaction Tracker Tab -->
        <div class="tab-content active" id="transaction-tracker">
            <div class="controls">
                <div class="control-item">
                    <label for="startTx">Starttransaktion:</label>
                    <input type="text" id="startTx" placeholder="Transaktions-Hash eingeben" style="width: 100%;">
                </div>
                <div class="control-item">
                    <label for="targetCurrency">Zielwährung:</label>
                    <select id="targetCurrency">
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                        <option value="SOL" selected>SOL</option>
                    </select>
                </div>
                <div class="control-item">
                    <label for="numTransactions">Anzahl Transaktionen:</label>
                    <input type="number" id="numTransactions" min="1" max="100" value="10">
                </div>
                <div class="control-item">
                    <button id="trackButton" style="width: 100%;">Transaktionen verfolgen</button>
                </div>
            </div>
            <div class="info-panel">
                <div class="info-card">
                    <h3>Start-Informationen</h3>
                    <div id="startInfo">
                        <div class="transaction-item">
                            <span>Währung:</span>
                            <span id="sourceCurrency" class="transaction-value">-</span>
                        </div>
                        <div class="transaction-item">
                            <span>Hash:</span>
                            <span id="startHash" class="transaction-value" style="word-break: break-all; font-size: 0.9em;">-</span>
                        </div>
                        <div class="transaction-item">
                            <span>Zeitstempel:</span>
                            <span id="startTime" class="transaction-value">-</span>
                        </div>
                    </div>
                </div>
                <div class="info-card">
                    <h3>Transaktionsstatistik</h3>
                    <div id="txStats">
                        <div class="transaction-item">
                            <span>Anzahl verfolgt:</span>
                            <span id="txCount" class="transaction-value">-</span>
                        </div>
                        <div class="transaction-item">
                            <span>Gesamtwert:</span>
                            <span id="totalValue" class="transaction-value">-</span>
                        </div>
                        <div class="transaction-item">
                            <span>Gesamtgebühren:</span>
                            <span id="totalFees" class="transaction-value">-</span>
                        </div>
                    </div>
                </div>
                <div class="info-card">
                    <h3>Konvertierung</h3>
                    <div id="conversionInfo">
                        <div class="transaction-item">
                            <span>Zielwährung:</span>
                            <span id="targetCurrencyDisplay" class="transaction-value">-</span>
                        </div>
                        <div class="transaction-item">
                            <span>Wechselkurs:</span>
                            <span id="exchangeRate" class="transaction-value">-</span>
                        </div>
                        <div class="transaction-item">
                            <span>Wert in Zielwährung:</span>
                            <span id="convertedValue" class="transaction-value">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="visualization">
                <div id="transactionTree" class="loading"></div>
            </div>
        </div>
        
        <!-- Social Analysis Tab -->
        <div class="tab-content" id="social-analysis">
            <form id="analysisForm" onsubmit="event.preventDefault(); submitAnalysis();">
                <div>
                    <label for="blockchain">Blockchain:</label>
                    <select id="blockchain" required>
                        <option value="ethereum">Ethereum</option>
                        <option value="binance">Binance</option>
                        <option value="polygon">Polygon</option>
                        <option value="solana">Solana</option>
                    </select>
                    <small>Wählen Sie die Blockchain aus, z. B. Ethereum oder Solana.</small>
                </div>
                <div>
                    <label for="contract_address">Contract-Adresse (optional):</label>
                    <input id="contract_address" type="text" placeholder="z.B. 0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984">
                    <small>Geben Sie die eindeutige Adresse des Smart Contracts ein, wenn Sie einen spezifischen Coin analysieren möchten.</small>
                </div>
                <div>
                    <label for="twitter_username">Twitter-Benutzername:</label>
                    <input id="twitter_username" type="text" placeholder="z.B. @example" required>
                    <small>Geben Sie den Twitter-Benutzernamen der Person oder des Projekts ein, das analysiert werden soll.</small>
                </div>
                <div>
                    <label for="keywords">Keywords (durch Komma getrennt):</label>
                    <input id="keywords" type="text" placeholder="z.B. Uniswap, UNI, DEX" required>
                    <small>Geben Sie Schlüsselwörter ein, um relevante Tweets zu finden, z. B. Projektnamen oder Token.</small>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label for="start_date">Startdatum:</label>
                        <input id="start_date" type="date" required>
                    </div>
                    <div>
                        <label for="end_date">Enddatum:</label>
                        <input id="end_date" type="date" required>
                    </div>
                </div>
                <div>
                    <label for="tweet_limit">Tweet-Limit:</label>
                    <input id="tweet_limit" type="number" min="10" max="5000" value="100">
                    <small>Die maximale Anzahl an Tweets, die analysiert werden sollen (10 bis 5000).</small>
                </div>
                <button type="submit">Analyse starten</button>
            </form>
            <div id="result" style="display: none;"></div>
        </div>
    </div>
</body>
</html>
